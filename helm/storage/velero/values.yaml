velero:
  installCRDs: true
  upgradeCRDs: true
  namespace: storage
  priorityClassName: system-cluster-critical
  initContainers:
    - name: velero-plugin-for-gcp
      image: velero/velero-plugin-for-gcp:v1.5.1
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - mountPath: /target
          name: plugins
    - name: velero-plugin-for-csi
      image: velero/velero-plugin-for-csi:v0.3.1
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - mountPath: /target
          name: plugins
  
  deployRestic: true
  restic:
    podVolumePath: /var/lib/kubelet/pods
    privileged: true
    resources:
      requests:
        memory: 0Mi
        cpu: 15m

  configuration:
    features: EnableCSI
    defaultVolumesToRestic: true
    extraEnvVars:
      TZ: "Australia/Sydney"
    provider: gcp
    backupStorageLocation:
      name: default
      provider: gcp
      bucket: rook-backups
      prefix: velero/
      default: true
      accessMode: ReadWrite
    
    volumeSnapshotLocation:
      name: default-snapshot
      provider: csi

  credentials:
    useSecret: true
    existingSecret: velero-cloud-secrets

  metrics:
    serviceMonitor:
      enabled: true
      namespace: monitoring


    prometheusRule:
      enabled: true
      namespace: monitoring
      spec:
      - alert: VeleroBackupPartialFailures
        annotations:
          message: Velero backup {{ $labels.schedule }} has {{ $value | humanizePercentage }} partialy failed backups.
        expr: |-
          velero_backup_partial_failure_total{schedule!=""} / velero_backup_attempt_total{schedule!=""} > 0.25
        for: 15m
        labels:
          severity: critical
      - alert: VeleroBackupFailures
        annotations:
          message: Velero backup {{ $labels.schedule }} has {{ $value | humanizePercentage }} failed backups.
        expr: |-
          velero_backup_failure_total{schedule!=""} / velero_backup_attempt_total{schedule!=""} > 0.25
        for: 15m
        labels:
          severity: critical


  schedules:
    schedule-hourly:
      schedule: "40 * * * *"
      template:
        labelSelector:
          matchLabels:
            velero.io/schedule: hourly
        ttl: "2160h"
        defaultVolumesToRestic: true
        includedNamespaces:
          - "*"
    schedule-weekly:
      schedule: "0 * * * 0"
      template:
        labelSelector:
          matchLabels:
            velero.io/schedule: weekly
        ttl: "2160h"
        defaultVolumesToRestic: true
        includedNamespaces:
          - "*"
    schedule-monthly:
      schedule: "0 4 * * WED"
      template:
        defaultVolumesToRestic: true
        labelSelector:
          matchLabels:
            velero.io/schedule: monthly
        ttl: "2160h"
        includedNamespaces:
          - "*"