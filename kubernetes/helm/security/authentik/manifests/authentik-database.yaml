apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: &name authentik-database
spec:
  instances: 3
  primaryUpdateStrategy: unsupervised
  bootstrap:
#    recovery:
#      database: authentik
#      owner: authentik
#      source: *name
#     Create a new DB, hopefully never needed!
     initdb:
       database: authentik
       owner: authentik
  storage:
    storageClass: local-path
    size: 5Gi

  monitoring:
    enablePodMonitor: true

  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: preferred

  externalClusters:
    - name: *name
      barmanObjectStore: &barmanObjectStore
        destinationPath: "s3://homelab-k8s-tcash/"
        serverName: *name
        googleCredentials:
          gkeEnvironment: false
          applicationCredentials:
            name: cloudnativepg-secrets
            key: gcsCredentials

  backup:
    retentionPolicy: 180d
    barmanObjectStore:
      <<: *barmanObjectStore

---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: authentik-backup
spec:
  immediate: true
  schedule: "@weekly"
  backupOwnerReference: self
  cluster:
    name: authentik-database
